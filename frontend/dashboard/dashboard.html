<!-- 
=========================================================
 Light Bootstrap Dashboard - v2.0.1
=========================================================

 Product Page: https://www.creative-tim.com/product/light-bootstrap-dashboard
 Copyright 2019 Creative Tim (https://www.creative-tim.com)
 Licensed under MIT (https://github.com/creativetimofficial/light-bootstrap-dashboard/blob/master/LICENSE)

 Coded by Creative Tim

=========================================================

 The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.  -->
<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8" />
    <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/apple-icon.png">
    <link rel="icon" type="image/png" href="../assets/img/favicon.ico">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>Firebird</title>
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
    <!--     Fonts and icons     -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700,200" rel="stylesheet" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" />
    <!-- CSS Files -->
    <link href="../assets/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../assets/css/light-bootstrap-dashboard.css?v=2.0.0 " rel="stylesheet" />

    <!-- <link href="../assets/css/demo.css" rel="stylesheet" /> -->
</head>

<body>
    <div class="wrapper">
        <div class="sidebar" data-image="../assets/img/sidebar-5.jpg" data-color="orange">
            <!--
        Tip 1: You can change the color of the sidebar using: data-color="purple | blue | green | orange | red"

        Tip 2: you can also add an image using data-image tag
    -->
            <div class="sidebar-wrapper">
                <div class="logo">
                    <a href="dashboard.html" class="simple-text">
                        Análisis de campaña
                    </a>
                </div>
                <ul class="nav">
                    <li class="nav-item active">
                        <a class="nav-link" href="dashboard.html">
                            <i class="nc-icon nc-chart-pie-35"></i>
                            <p>Panel de control</p>
                        </a>
                    </li>
                    <li>
                        <a class="nav-link" href="./maps.html">
                            <i class="nc-icon nc-pin-3"></i>
                            <p>Mapa</p>
                        </a>
                    </li>
                    <li>
                        <a class="nav-link" href="./global.html">
                            <i class="nc-icon nc-globe-2"></i>
                            <p>Tendencias globales</p>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="main-panel">
            <!-- Navbar -->
            <nav class="navbar navbar-expand-lg" color-on-scroll="500">
                <div class="container-fluid">
                    <a class="navbar-brand" href="#pablo"> Panel de control </a>
                    <button style="visibility: hidden;" href="" class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-bar burger-lines"></span>
                        <span class="navbar-toggler-bar burger-lines"></span>
                        <span class="navbar-toggler-bar burger-lines"></span>
                    </button>
                    <div style="visibility: hidden;" class="collapse navbar-collapse justify-content-end" id="navigation">
                        <ul class="nav navbar-nav mr-auto">
                            <li class="nav-item">
                                <a href="#" class="nav-link" data-toggle="dropdown">
                                    <i class="nc-icon nc-palette"></i>
                                    <span class="d-lg-none">Dashboard</span>
                                </a>
                            </li>
                            <li class="dropdown nav-item">
                                <a href="#" class="dropdown-toggle nav-link" data-toggle="dropdown">
                                    <i class="nc-icon nc-planet"></i>
                                    <span class="notification">5</span>
                                    <span class="d-lg-none">Notification</span>
                                </a>
                                <ul class="dropdown-menu">
                                    <a class="dropdown-item" href="#">Notification 1</a>
                                    <a class="dropdown-item" href="#">Notification 2</a>
                                    <a class="dropdown-item" href="#">Notification 3</a>
                                    <a class="dropdown-item" href="#">Notification 4</a>
                                    <a class="dropdown-item" href="#">Another notification</a>
                                </ul>
                            </li>
                            <li class="nav-item">
                                <a href="#" class="nav-link">
                                    <i class="nc-icon nc-zoom-split"></i>
                                    <span class="d-lg-block">&nbsp;Search</span>
                                </a>
                            </li>
                        </ul>
                        <ul class="navbar-nav ml-auto">
                            <li class="nav-item">
                                <a class="nav-link" href="#pablo">
                                    <span class="no-icon">Account</span>
                                </a>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="http://example.com" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <span class="no-icon">Dropdown</span>
                                </a>
                                <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                                    <a class="dropdown-item" href="#">Action</a>
                                    <a class="dropdown-item" href="#">Another action</a>
                                    <a class="dropdown-item" href="#">Something</a>
                                    <a class="dropdown-item" href="#">Something else here</a>
                                    <div class="divider"></div>
                                    <a class="dropdown-item" href="#">Separated link</a>
                                </div>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#pablo">
                                    <span class="no-icon">Log out</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
            <!-- End Navbar -->
            <div class="content">
                <div class="container-fluid">                   
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card ">
                                <div class="card-header ">
                                    <h4 class="card-title">Tweets diarios</h4>
                                    <p class="card-category"></p>
                                </div>
                                <div class="card-body ">
                                    <div id="chartPreferences" class="ct-chart ct-perfect-fourth"></div>
                                </div>
                                <div class="card-footer">
                                <div class="legend">
                                        <i class="fa fa-circle text-info"></i> Positivos
                                        <i class="fa fa-circle text-danger"></i> Negativos
                                        <i class="fa fa-circle text-warning"></i> Neutros
                                    </div>
                                    <hr>
                                    <div class="stats">
                                        <i class="fa fa-clock-o"></i> Datos actualizados diariamente
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card ">
                                <div class="card-header ">
                                    <h4 class="card-title">Evolución en el tiempo</h4>
                                    <p class="card-category"></p>
                                </div>
                                <div class="card-body ">
                                    <div id="chartHours" class="ct-chart"></div>
                                </div>
                                <div class="card-footer ">
                                    <div class="legend">
                                        <i class="fa fa-circle text-info"></i> Positivos
                                        <i class="fa fa-circle text-danger"></i> Negativos
                                        <i class="fa fa-circle text-warning"></i> Neutros
                                    </div>
                                    <hr>
                                    <div class="stats">
                                        <i class="fa fa-history"></i> Datos actualizados diariamente
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card ">
                                <div class="card-header ">
                                    <h4 class="card-title">Tweets diarios</h4>
                                    <p class="card-category"> </p>
                                </div>
                                <div class="card-body ">
                                    <div class="typography-line text-right">
                                        <h2 id="tweetsDiarios">Cargando...</h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card ">
                                <div class="card-header ">
                                    <h4 class="card-title">Días de campaña</h4>
                                    <p class="card-category"></p>
                                </div>
                                <div class="card-body ">
                                    <div class="typography-line text-right">
                                        <h2 id="diasCampana">Cargando...</h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card ">
                                <div class="card-header ">
                                    <h4 class="card-title">Total de tweets analizados</h4>
                                    <p class="card-category"></p>
                                </div>
                                <div class="card-body ">
                                    <div class="typography-line text-right">
                                        <h2 id="tweetsTotal">Cargando...</h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="footer">
                <div class="container-fluid">
                    <nav>
                        <ul class="footer-menu">

                        </ul>
                        <p class="copyright text-center">
                            ©
                            <script>
                                document.write(new Date().getFullYear())
                            </script>
                             Firebird. Plantilla Light Bootstrap Dashboard de <a href="http://www.creative-tim.com">Creative Tim</a>.
                        </p>
                    </nav>
                </div>
            </footer>
        </div>
    </div>

</body>
<!--   Core JS Files   -->
<script src="../assets/js/core/jquery.3.2.1.min.js" type="text/javascript"></script>
<script src="../assets/js/core/popper.min.js" type="text/javascript"></script>
<script src="../assets/js/core/bootstrap.min.js" type="text/javascript"></script>
<!--  Plugin for Switches, full documentation here: http://www.jque.re/plugins/version3/bootstrap.switch/ -->
<script src="../assets/js/plugins/bootstrap-switch.js"></script>

<!--  Chartist Plugin  -->
<script src="../assets/js/plugins/chartist.min.js"></script>
<!--  Notifications Plugin    -->
<script src="../assets/js/plugins/bootstrap-notify.js"></script>
<!-- Control Center for Light Bootstrap Dashboard: scripts for the example pages etc -->
<script src="../assets/js/light-bootstrap-dashboard.js?v=2.0.0 " type="text/javascript"></script>
<script src="../assets/js/demo.js"></script>



<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";  
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics.js";
    import { getFirestore, doc, getDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
   
    const firebaseConfig = {  
      apiKey: "AIzaSyC7FQzl3ers05n809FplN6ghejKrU0wFh4",  
      authDomain: "firebirdbackend.firebaseapp.com",  
      projectId: "firebirdbackend",  
      storageBucket: "firebirdbackend.appspot.com",  
      messagingSenderId: "362751348570",  
      appId: "1:362751348570:web:fb21580d01aabcbc356d63",  
      measurementId: "G-ZVXW3PC2X3"  
    };
    
    const app = initializeApp(firebaseConfig);  
    const analytics = getAnalytics(app);

    // Autentificación de usuarios
    const auth = getAuth();
    onAuthStateChanged(auth, (user) => {
    if (user) {
        console.log("Usuario" + user.uid + "logueado");
        const uid = user.uid;        
    } else {
        // Si estamos aquí, el usuario no está logueado
        console.log("Usuario no logueado");
        console.log("Redirigiendo a página de login");        
        window.location.replace("../login/index.html");
    }
    });

    // Firestore
    const db = getFirestore();
    // Aquí auth.currentuser es null
    const docRef = doc(db, "data", "total");
    const docSnap = await getDoc(docRef);

    // Después del await auth.currentuser ya está disponible
    const docRef2 = doc(db, "data", auth.currentUser.uid);
    const docSnap2 = await getDoc(docRef2);    
    const lastUpdate = docSnap2.data().lastUpdate;
    console.log("Last update:", lastUpdate);

    const docRef3 = doc(db, "data", auth.currentUser.uid, "days", lastUpdate, "cities", "total")
    const docSnap3 = await getDoc(docRef3);

    var allDays = []
    const querySnapshot = await getDocs(collection(db, "data", auth.currentUser.uid, "days"));
    querySnapshot.forEach((doc) => {
    // doc.data() is never undefined for query doc snapshots
        allDays.push(doc.id)
    });
    allDays.sort()

    console.log("All info available:",allDays);

    // Nota: foreach NO funciona, usar for
    var day;
    var lineChartLabels = []
    var lineChartPos = []
    var lineChartNeg = []
    var lineChartNeut = []

    for (day of allDays) {
        // console.log(user.id, " => ", user.data());
        var docRefD = doc(db, "data", auth.currentUser.uid, "days", day, "cities", "total")
        var docSnapD = await getDoc(docRefD);
        lineChartLabels.push(day)
        lineChartPos.push(docSnapD.data()['pos'])
        lineChartNeg.push(docSnapD.data()['neg'])
        lineChartNeut.push(docSnapD.data()['neut'])
    }

    Chartist.Pie('#chartPreferences', {
            labels: [docSnap3.data()['pos'], docSnap3.data()['neg'], docSnap3.data()['neut']],
            series: [docSnap3.data()['pos'], docSnap3.data()['neg'], docSnap3.data()['neut']]
    });

    var chartHours = Chartist.Line('#chartHours', {
            labels: lineChartLabels,
            series: [lineChartPos, lineChartNeg, lineChartNeut]
    });

    document.getElementById("tweetsDiarios").textContent = docSnap3.data()['pos']+docSnap3.data()['neg']+docSnap3.data()['neut'];
    document.getElementById("diasCampana").textContent = allDays.length;
    document.getElementById("tweetsTotal").textContent = lineChartPos.concat(lineChartNeut).concat(lineChartNeg).reduce((a,b)=>a+b);

  </script>

</html>
